name: Release

on:
  push:
    tags:
      - "v*"

jobs:
  tauri-release:
    permissions:
      contents: write
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Sync app version from tag
        run: |
          node -e 'const fs=require("fs");const tag=process.env.GITHUB_REF_NAME||"";const version=tag.replace(/^v/,"");if(!version){throw new Error(`Invalid tag: ${tag}`);}for(const file of["package.json","src-tauri/tauri.conf.json"]){const data=JSON.parse(fs.readFileSync(file,"utf8"));data.version=version;fs.writeFileSync(file,JSON.stringify(data,null,2)+"\n");}console.log(`Version synced to ${version}`);'
        env:
          GITHUB_REF_NAME: ${{ github.ref_name }}

      - name: Detect macOS signing and notarization secrets
        id: signing
        shell: bash
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          required=(APPLE_CERTIFICATE APPLE_CERTIFICATE_PASSWORD APPLE_ID APPLE_PASSWORD APPLE_TEAM_ID)
          missing=()
          for key in "${required[@]}"; do
            if [ -z "${!key}" ]; then
              missing+=("$key")
            fi
          done
          if [ "${#missing[@]}" -gt 0 ]; then
            echo "enabled=false" >> "$GITHUB_OUTPUT"
            echo "missing=${missing[*]}" >> "$GITHUB_OUTPUT"
            echo "::warning::Missing signing secrets: ${missing[*]}"
            echo "::warning::Publishing unsigned macOS bundle."
          else
            echo "enabled=true" >> "$GITHUB_OUTPUT"
            echo "::notice::All signing secrets are present. Publishing signed and notarized bundle."
          fi

      - name: Install JS dependencies
        run: npm ci

      - name: Build and Publish Signed Tauri Bundles
        if: steps.signing.outputs.enabled == 'true'
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        with:
          tagName: ${{ github.ref_name }}
          releaseName: PR Tracker ${{ github.ref_name }}
          releaseBody: |
            Automated release for PR Tracker.
            Download the installer for your platform from the assets below.
            This release is signed and notarized for macOS.
          releaseDraft: false
          prerelease: false

      - name: Build and Publish Unsigned Tauri Bundles
        if: steps.signing.outputs.enabled != 'true'
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: ${{ github.ref_name }}
          releaseName: PR Tracker ${{ github.ref_name }}
          releaseBody: |
            Automated release for PR Tracker.
            Download the installer for your platform from the assets below.
            This release is UNSIGNED and UNNOTARIZED because Apple signing secrets are missing.
            If macOS blocks opening, run:
            xattr -dr com.apple.quarantine /Applications/PR\ Tracker.app
          releaseDraft: false
          prerelease: false
